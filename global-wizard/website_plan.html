<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>App-Based IO Label Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f5f9;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #94a3b8;
        border-radius: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #64748b;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body class="bg-slate-100 text-slate-800">
    <!-- App Management Screen -->
    <div id="app-management-screen">
      <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="mb-8 flex justify-between items-center">
          <div>
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">
              App Manager
            </h1>
            <p class="text-slate-600 mt-2">
              Create and manage your I/O configurations.
            </p>
          </div>
          <button
            id="export-all-btn"
            class="bg-emerald-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-emerald-700 transition-colors duration-200"
          >
            Export All Apps (.zip)
          </button>
        </header>

        <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
          <div
            class="flex flex-col sm:flex-row gap-4 mb-6 pb-6 border-b border-slate-200"
          >
            <input
              type="text"
              id="new-app-name"
              placeholder="Enter new app name..."
              class="flex-grow block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
            />
            <button
              id="add-app-btn"
              class="w-full sm:w-auto bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-indigo-700 transition-colors duration-200"
            >
              Create App
            </button>
          </div>

          <h2 class="text-xl font-semibold text-slate-900 mb-4">
            Existing Apps
          </h2>
          <div id="app-list" class="space-y-3">
            <!-- App list will be dynamically generated here -->
            <p id="no-apps-message" class="text-slate-500">
              No apps found. Create one to get started.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- App Detail/Editor Screen -->
    <div id="app-detail-screen" class="hidden">
      <div class="container mx-auto p-4 md:p-8 max-w-screen-2xl">
        <header class="mb-8">
          <h1
            id="app-detail-title"
            class="text-3xl md:text-4xl font-bold text-slate-900"
          ></h1>
          <p class="text-slate-600 mt-2">
            Define, label, import, and export your digital I/O and Register
            configurations for this app.
          </p>
        </header>

        <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
          <div
            class="grid grid-cols-1 md:grid-cols-4 gap-6 border-b border-slate-200 pb-8 mb-8"
          >
            <div class="md:col-span-3">
              <div class="flex items-center gap-4">
                <button
                  id="back-to-apps-btn"
                  class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors duration-200"
                >
                  &larr; Back
                </button>
                <h2 class="text-xl font-semibold text-slate-900">
                  Configuration
                </h2>
              </div>
            </div>
            <div
              class="md:col-span-1 flex items-end justify-start md:justify-end space-x-3"
            >
              <button
                id="import-btn"
                class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-indigo-700 transition-colors duration-200"
              >
                Import
              </button>
              <input type="file" id="file-input" class="hidden" accept=".dt" />
            </div>

            <!-- Updated Configuration Section -->
            <div
              class="md:col-span-4 grid grid-cols-1 lg:grid-cols-3 gap-x-8 gap-y-6"
            >
              <!-- DI Config -->
              <div class="p-4 bg-slate-50 rounded-lg border">
                <h3 class="font-semibold text-slate-800 mb-3">
                  Digital Inputs (DI)
                </h3>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label
                      for="di-size"
                      class="block text-sm font-medium text-slate-700"
                      >Size</label
                    >
                    <input
                      type="number"
                      id="di-size"
                      value="16"
                      min="0"
                      class="config-input mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                    />
                  </div>
                  <div>
                    <label
                      for="di-start-point"
                      class="block text-sm font-medium text-slate-700"
                      >Start Point</label
                    >
                    <input
                      type="number"
                      id="di-start-point"
                      value="1"
                      min="0"
                      class="config-input mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                    />
                  </div>
                </div>
              </div>
              <!-- DO Config -->
              <div class="p-4 bg-slate-50 rounded-lg border">
                <h3 class="font-semibold text-slate-800 mb-3">
                  Digital Outputs (DO)
                </h3>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label
                      for="do-size"
                      class="block text-sm font-medium text-slate-700"
                      >Size</label
                    >
                    <input
                      type="number"
                      id="do-size"
                      value="16"
                      min="0"
                      class="config-input mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                    />
                  </div>
                  <div>
                    <label
                      for="do-start-point"
                      class="block text-sm font-medium text-slate-700"
                      >Start Point</label
                    >
                    <input
                      type="number"
                      id="do-start-point"
                      value="1"
                      min="0"
                      class="config-input mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                    />
                  </div>
                </div>
              </div>
              <!-- R Config -->
              <div class="p-4 bg-slate-50 rounded-lg border">
                <h3 class="font-semibold text-slate-800 mb-3">Registers (R)</h3>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label
                      for="r-size"
                      class="block text-sm font-medium text-slate-700"
                      >Size</label
                    >
                    <input
                      type="number"
                      id="r-size"
                      value="16"
                      min="0"
                      class="config-input mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                    />
                  </div>
                  <div>
                    <label
                      for="r-start-point"
                      class="block text-sm font-medium text-slate-700"
                      >Start Point</label
                    >
                    <input
                      type="number"
                      id="r-start-point"
                      value="1"
                      min="0"
                      class="config-input mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                    />
                  </div>
                </div>
              </div>
            </div>

            <div class="md:col-span-4 mt-4">
              <button
                id="generate-btn"
                class="w-full md:w-auto bg-slate-800 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-slate-900 transition-colors duration-200"
              >
                Generate Fields
              </button>
            </div>
          </div>

          <div
            id="io-container"
            class="grid grid-cols-1 lg:grid-cols-3 gap-8 hidden"
          >
            <div id="di-container">
              <h3 class="text-lg font-semibold text-slate-900 mb-4">DI</h3>
              <div
                id="di-table-container"
                class="max-h-[60vh] overflow-y-auto custom-scrollbar pr-2"
              ></div>
            </div>
            <div id="do-container">
              <h3 class="text-lg font-semibold text-slate-900 mb-4">DO</h3>
              <div
                id="do-table-container"
                class="max-h-[60vh] overflow-y-auto custom-scrollbar pr-2"
              ></div>
            </div>
            <div id="r-container">
              <h3 class="text-lg font-semibold text-slate-900 mb-4">R</h3>
              <div
                id="r-table-container"
                class="max-h-[60vh] overflow-y-auto custom-scrollbar pr-2"
              ></div>
            </div>
          </div>
          <div id="welcome-message" class="text-center py-16">
            <svg
              class="mx-auto h-12 w-12 text-slate-400"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              aria-hidden="true"
            >
              <path
                vector-effect="non-scaling-stroke"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z"
              />
            </svg>
            <h3 class="mt-2 text-sm font-semibold text-slate-900">
              No Fields Generated
            </h3>
            <p class="mt-1 text-sm text-slate-500">
              Configure and click "Generate Fields" to start labeling.
            </p>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- State Management ---
        let currentAppName = null;
        const APP_STORAGE_KEY = "ioLabelerApps";

        // --- DOM Element References ---
        const appManagementScreen = document.getElementById(
          "app-management-screen"
        );
        const appDetailScreen = document.getElementById("app-detail-screen");
        const appListContainer = document.getElementById("app-list");
        const newAppNameInput = document.getElementById("new-app-name");
        const addAppBtn = document.getElementById("add-app-btn");
        const noAppsMessage = document.getElementById("no-apps-message");
        const backToAppsBtn = document.getElementById("back-to-apps-btn");
        const appDetailTitle = document.getElementById("app-detail-title");
        const exportAllBtn = document.getElementById("export-all-btn");

        // Detail Screen Elements
        const diSizeInput = document.getElementById("di-size");
        const doSizeInput = document.getElementById("do-size");
        const rSizeInput = document.getElementById("r-size");
        const diStartPointInput = document.getElementById("di-start-point");
        const doStartPointInput = document.getElementById("do-start-point");
        const rStartPointInput = document.getElementById("r-start-point");

        const generateBtn = document.getElementById("generate-btn");
        const importBtn = document.getElementById("import-btn");
        const fileInput = document.getElementById("file-input");
        const diTableContainer = document.getElementById("di-table-container");
        const doTableContainer = document.getElementById("do-table-container");
        const rTableContainer = document.getElementById("r-table-container");
        const ioContainer = document.getElementById("io-container");
        const welcomeMessage = document.getElementById("welcome-message");

        // --- Local Storage Functions ---
        const getApps = () =>
          JSON.parse(localStorage.getItem(APP_STORAGE_KEY)) || {};
        const saveApps = (apps) =>
          localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(apps));

        // --- App Management Logic ---
        const renderAppList = () => {
          const apps = getApps();
          const appNames = Object.keys(apps);
          appListContainer.innerHTML = ""; // Clear list

          if (appNames.length === 0) {
            noAppsMessage.classList.remove("hidden");
          } else {
            noAppsMessage.classList.add("hidden");
            appNames.sort().forEach((appName) => {
              const appElement = document.createElement("div");
              appElement.className =
                "flex justify-between items-center p-4 bg-slate-50 rounded-lg border border-slate-200";
              appElement.innerHTML = `
                        <span class="font-medium text-slate-800">${appName}</span>
                        <div>
                            <button data-appname="${appName}" class="select-app-btn text-indigo-600 hover:text-indigo-800 font-semibold mr-4">Open</button>
                            <button data-appname="${appName}" class="delete-app-btn text-red-500 hover:text-red-700 font-semibold">Delete</button>
                        </div>
                    `;
              appListContainer.appendChild(appElement);
            });
          }
        };

        addAppBtn.addEventListener("click", () => {
          const appName = newAppNameInput.value.trim();
          if (!appName) {
            alert("Please enter a valid app name.");
            return;
          }
          const apps = getApps();
          if (apps[appName]) {
            alert("An app with this name already exists.");
            return;
          }
          apps[appName] = {
            config: {
              diSize: 16,
              diStartPoint: 1,
              doSize: 16,
              doStartPoint: 1,
              rSize: 16,
              rStartPoint: 1,
            },
            labels: { di: {}, do: {}, r: {} },
          };
          saveApps(apps);
          newAppNameInput.value = "";
          renderAppList();
        });

        appListContainer.addEventListener("click", (e) => {
          const appName = e.target.dataset.appname;
          if (!appName) return;

          if (e.target.classList.contains("select-app-btn")) {
            currentAppName = appName;
            loadAppDetail(appName);
            appManagementScreen.classList.add("hidden");
            appDetailScreen.classList.remove("hidden");
          }
          if (e.target.classList.contains("delete-app-btn")) {
            if (
              confirm(
                `Are you sure you want to delete the app "${appName}"? This cannot be undone.`
              )
            ) {
              const apps = getApps();
              delete apps[appName];
              saveApps(apps);
              renderAppList();
            }
          }
        });

        backToAppsBtn.addEventListener("click", () => {
          saveCurrentApp(); // Auto-save on leaving
          currentAppName = null;
          appManagementScreen.classList.remove("hidden");
          appDetailScreen.classList.add("hidden");
        });

        // --- App Detail Logic ---
        const loadAppDetail = (appName) => {
          const apps = getApps();
          const appData = apps[appName];
          if (!appData) return;

          appDetailTitle.textContent = `Editing: ${appName}`;
          const { config, labels } = appData;

          diSizeInput.value = config.diSize;
          diStartPointInput.value = config.diStartPoint;
          doSizeInput.value = config.doSize;
          doStartPointInput.value = config.doStartPoint;
          rSizeInput.value = config.rSize;
          rStartPointInput.value = config.rStartPoint;

          generateIOFields(labels);
        };

        const saveCurrentApp = () => {
          if (!currentAppName) return;
          const apps = getApps();
          if (!apps[currentAppName]) return;

          const labels = { di: {}, do: {}, r: {} };
          document
            .querySelectorAll('#io-container input[type="text"]')
            .forEach((input) => {
              const { type, point } = input.dataset;
              const label = input.value.trim();
              if (label) {
                labels[type][point] = label;
              }
            });

          apps[currentAppName] = {
            config: {
              diSize: parseInt(diSizeInput.value) || 0,
              diStartPoint: parseInt(diStartPointInput.value) || 0,
              doSize: parseInt(doSizeInput.value) || 0,
              doStartPoint: parseInt(doStartPointInput.value) || 0,
              rSize: parseInt(rSizeInput.value) || 0,
              rStartPoint: parseInt(rStartPointInput.value) || 0,
            },
            labels: labels,
          };
          saveApps(apps);
        };

        generateBtn.addEventListener("click", () => {
          const apps = getApps();
          apps[currentAppName].labels = { di: {}, do: {}, r: {} };
          saveApps(apps);
          generateIOFields();
          saveCurrentApp();
        });

        document.querySelectorAll(".config-input").forEach((input) => {
          input.addEventListener("change", saveCurrentApp);
        });

        appDetailScreen.addEventListener("change", (e) => {
          if (e.target.matches("input[data-point]")) {
            saveCurrentApp();
          }
        });

        function generateIOFields(prefillData = { di: {}, do: {}, r: {} }) {
          const config = {
            diSize: parseInt(diSizeInput.value) || 0,
            diStartPoint: parseInt(diStartPointInput.value) || 0,
            doSize: parseInt(doSizeInput.value) || 0,
            doStartPoint: parseInt(doStartPointInput.value) || 0,
            rSize: parseInt(rSizeInput.value) || 0,
            rStartPoint: parseInt(rStartPointInput.value) || 0,
          };

          diTableContainer.innerHTML = "";
          doTableContainer.innerHTML = "";
          rTableContainer.innerHTML = "";

          if (
            config.diSize === 0 &&
            config.doSize === 0 &&
            config.rSize === 0
          ) {
            welcomeMessage.classList.remove("hidden");
            ioContainer.classList.add("hidden");
            return;
          }

          welcomeMessage.classList.add("hidden");
          ioContainer.classList.remove("hidden");

          const createTableContent = (
            container,
            type,
            size,
            startPoint,
            data
          ) => {
            if (size > 0) {
              const table = createTable(type);
              for (let i = 0; i < size; i++) {
                const pointNumber = startPoint + i;
                const label = data[pointNumber] || "";
                const row = createTableRow(type, pointNumber, label);
                table.appendChild(row);
              }
              container.appendChild(table);
            }
          };

          createTableContent(
            diTableContainer,
            "di",
            config.diSize,
            config.diStartPoint,
            prefillData.di || {}
          );
          createTableContent(
            doTableContainer,
            "do",
            config.doSize,
            config.doStartPoint,
            prefillData.do || {}
          );
          createTableContent(
            rTableContainer,
            "r",
            config.rSize,
            config.rStartPoint,
            prefillData.r || {}
          );
        }

        function createTable(type) {
          const table = document.createElement("table");
          table.className = "w-full text-sm text-left text-slate-500";
          table.innerHTML = `<thead class="text-xs text-slate-700 uppercase bg-slate-50 sticky top-0"><tr><th scope="col" class="px-4 py-3 w-1/4">Point</th><th scope="col" class="px-4 py-3">Label</th></tr></thead><tbody></tbody>`;
          return table;
        }

        function createTableRow(type, pointNumber, label) {
          const tr = document.createElement("tr");
          tr.className = "bg-white border-b";
          tr.innerHTML = `<td class="px-4 py-2 font-medium text-slate-900 whitespace-nowrap">${pointNumber}</td><td class="px-4 py-2"><input type="text" data-type="${type}" data-point="${pointNumber}" value="${label}" class="w-full bg-transparent border-0 focus:ring-0 p-0 m-0 text-slate-700" placeholder="Enter label..."></td>`;
          return tr;
        }

        // --- Import/Export Logic ---
        importBtn.addEventListener("click", () => fileInput.click());
        fileInput.addEventListener("change", handleFileImport);

        function handleFileImport(e) {
          const file = e.target.files[0];
          if (!file || !currentAppName) return;

          const reader = new FileReader();
          reader.onload = (re) => {
            const content = re.target.result;
            try {
              const apps = getApps();
              const currentApp = apps[currentAppName];

              const parsedLabels = { di: {}, do: {}, r: {} };

              const parseSection = (type) => {
                const regex = new RegExp(
                  `\\[${type.toUpperCase()}\\]([\\s\\S]*?)\\[\\/${type.toUpperCase()}\\]`
                );
                const match = content.match(regex);
                if (match) {
                  match[1]
                    .trim()
                    .split("\n")
                    .forEach((line) => {
                      if (!line.trim()) return;
                      const [point, ...labelParts] = line.split(",");
                      const label = labelParts.join(",");
                      const pointNum = parseInt(point.trim());
                      if (!isNaN(pointNum)) {
                        parsedLabels[type][pointNum] = label.trim();
                      }
                    });
                }
              };

              ["di", "do", "r"].forEach(parseSection);

              const calculateConfig = (type) => {
                const points = Object.keys(parsedLabels[type]).map(Number);
                if (points.length === 0) return { size: 0, startPoint: 0 };
                const min = Math.min(...points);
                const max = Math.max(...points);
                return { size: max - min + 1, startPoint: min };
              };

              const diConfig = calculateConfig("di");
              const doConfig = calculateConfig("do");
              const rConfig = calculateConfig("r");

              currentApp.config = {
                diSize: diConfig.size,
                diStartPoint: diConfig.startPoint,
                doSize: doConfig.size,
                doStartPoint: doConfig.startPoint,
                rSize: rConfig.size,
                rStartPoint: rConfig.startPoint,
              };
              currentApp.labels = parsedLabels;
              saveApps(apps);
              loadAppDetail(currentAppName);
            } catch (error) {
              console.error("Failed to parse imported file:", error);
              alert(
                "Error: Could not parse the file. Please ensure it is in the correct format."
              );
            }
          };
          reader.readAsText(file);
          fileInput.value = "";
        }

        exportAllBtn.addEventListener("click", () => {
          const apps = getApps();
          const appNames = Object.keys(apps);
          if (appNames.length === 0) {
            alert("No apps to export.");
            return;
          }

          const zip = new JSZip();
          const rootFolder = zip.folder("Apps");

          appNames.forEach((appName) => {
            const appData = apps[appName];
            const appFolder = rootFolder.folder(appName);
            let manifestContent = "";

            const buildSection = (type) => {
              const points = Object.keys(appData.labels[type] || {});
              if (points.length > 0) {
                manifestContent += `[${type.toUpperCase()}]\n`;
                points
                  .sort((a, b) => Number(a) - Number(b))
                  .forEach((point) => {
                    manifestContent += `${point},${appData.labels[type][point]}\n`;
                  });
                manifestContent += `[/${type.toUpperCase()}]\n\n`;
              }
            };

            buildSection("di");
            buildSection("do");
            buildSection("r");

            appFolder.file("manifest.dt", manifestContent.trim());
          });

          zip.generateAsync({ type: "blob" }).then((content) => {
            const a = document.createElement("a");
            a.href = URL.createObjectURL(content);
            a.download = "Apps_Export.zip";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
          });
        });

        // --- Initial Load ---
        renderAppList();
      });
    </script>
  </body>
</html>
